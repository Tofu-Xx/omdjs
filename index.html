<head>
  <meta charset="UTF-8">
  <title>Oh My Dear JS</title>
  <link rel="shortcut icon" href="./favicon.png">
  <script src="https://unpkg.com/setupin"></script>
</head>

<script setup>
  import { ref, computed, useTemplateRef, watchEffect } from 'vue';
  const colorMap = {
    '===': '#902b20',
    '==': '#eb6c5f',
    '<= && >=': '#f1c40f',
    '<=': '#3498db',
    '>=': '#2ecc71',
    'else': '#bdc3c7',
  };
  const equalSet = ref(
    new Set(
      JSON.parse(localStorage.getItem('equalSet') ?? 'false')
      || ['""', '0n', 'false', '0', 'undefined', 'null', 'Symbol()', '{}', '[]']
    )
  );
  const isRect = ref(JSON.parse(localStorage.getItem('isRect')) ?? true);
  /*  */
  function getRelation(a, b) {
    for (const ope in colorMap)
      if (ope === 'else' || prefixEvaluate(ope, a, b))
        return ope;
  }
  function getCellAttr(b, a, ai, bi, len) {
    return {
      style: `background-color: ${colorMap[getRelation(a, b)]}`,
      ...(ai === 0 && { row: a }),
      ...(bi === len - 1 && { col: b }),
    };
  };
  /*  */
  const iptRef = useTemplateRef('ipt');
  /*  */
  const option = ref(
    JSON.parse(localStorage.getItem('option') ?? 'false')
    || Array(...equalSet.value)
  );
  function toggleHandler(v) {
    if (equalSet.value.has(v)) {
      equalSet.value.delete(v);
    } else {
      equalSet.value.add(v);
    }
  }
  function deleteHandler(v) {
    equalSet.value.delete(v);
    option.value = option.value.filter(k => k !== v);
  }
  /*  */
  const iptVal = ref('');
  const ctrl = {
    clear() {
      equalSet.value.clear();
    },
    all() {
      equalSet.value = new Set(option.value);
    },
    delete() {
      ctrl.clear();
      option.value = [];
    },
    shuffle() {
      const arr = [...equalSet.value];
      for (let i = arr.length - 1; i > 0; i--) {
        let j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      equalSet.value = new Set(arr);
    },
    sort() {
      const t = ['===', '==', '<= && >=', '<=', '>=', 'else'];
      equalSet.value = new Set([...equalSet.value]
        .sort((a, b) => t.indexOf(getRelation(a, a)) - t.indexOf(getRelation(b, b)))
        .sort((a, b) => prefixEvaluate('>=', a, b) ? 1 : -1)
        .sort((a, b) => prefixEvaluate('>=', a, b) ? 1 : -1)
      );
      option.value = [...new Set([...equalSet.value, ...option.value])];
    },
    rotate() {
      isRect.value = !isRect.value;
    },
  };
  function doCmd() {
    const isCmd = Object.hasOwn(ctrl, iptVal.value);
    isCmd && ctrl[iptVal.value]();
    iptVal.value = '';
    return isCmd;
  }
  function submitHandler(ipt) {
    ipt = ipt.trim();
    if (ipt === '') return;
    if (doCmd()) return;
    if (evaluate(ipt) instanceof Error) return;
    if (evaluate(`[${ipt}]`).length > 1) {
      ipt.split(',').forEach(submitHandler);
      return;
    }
    toggleHandler(ipt);
    option.value.includes(ipt) || option.value.push(ipt);
    iptVal.value = '';
  }
  /*  */
  watchEffect(() => {
    localStorage.setItem('equalSet', JSON.stringify(Array(...equalSet.value)));
    localStorage.setItem('option', JSON.stringify(option.value));
    localStorage.setItem('isRect', isRect.value);
    iptRef.value?.focus();
  });
  /*  */
</script>

<template>
  <main>
    <ol id="equal-rect">
      <li v-for="(outside,outi) of equalSet">
        <ol>
          <li
            v-show="isRect || outi <= ini" v-for="(inside,ini) of equalSet"
            v-bind="getCellAttr(outside,inside,outi,ini,equalSet.size)">
          </li>
        </ol>
      </li>
    </ol>
    <ul id="color-tag">
      <li v-for="(v,k) of colorMap">
        <pre :style="{backgroundColor: v}">{{ k }}</pre>
      </li>
    </ul>
    <ul>
      <li v-for="v of option">
        <button
          :style="equalSet.has(v)&&`background-color: ${colorMap.else}`"
          @click="toggleHandler(v)"
          @contextmenu.prevent="deleteHandler(v)">{{ v }}</button>
      </li>
    </ul>
    <form @submit.prevent="submitHandler(iptVal)">
      <input v-model.trim="iptVal" ref="ipt">
    </form>
    <ul>
      <li v-for="(f,k) of ctrl">
        <button @click="f" type="button">{{ k }}</button>
      </li>
    </ul>
  </main>
</template>

<style>
  @import "https://unpkg.com/@tofukit/resetcss@latest";

  body {
    background: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAPwAAADmCAYAAADx5uiaAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA+FpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczpkYz0iaHR0cDovL3B1cmwub3JnL2RjL2VsZW1lbnRzLzEuMS8iIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCIgeG1wOkNyZWF0ZURhdGU9IjIwMTEtMTAtMTJUMTg6MTM6MTgrMDI6MDAiIHhtcDpNb2RpZnlEYXRlPSIyMDExLTEwLTEyVDE2OjE3KzAyOjAwIiB4bXA6TWV0YWRhdGFEYXRlPSIyMDExLTEwLTEyVDE2OjE3KzAyOjAwIiBkYzpmb3JtYXQ9ImltYWdlL3BuZyIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDpEN0ZDMjJERkVEMTAxMUUwODA4OEY5QUFEQTQzOTFCNyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDpEN0ZDMjJFMEVEMTAxMUUwODA4OEY5QUFEQTQzOTFCNyI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkQ3RkMyMkRERUQxMDExRTA4MDg4RjlBQURBNDM5MUI3IiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOkQ3RkMyMkRFRUQxMDExRTA4MDg4RjlBQURBNDM5MUI3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+59nK8wAABF5JREFUeNrs3FturDAURFHzmP+MwTdIaekOwKVQ6rWk/FqN8Sbwc7YxxvHzt4/1rsXrbT9/9+I1j8B1P3s57efS/bwL9jNx34/EZgJfQvAgeEDwgOABwQOCBwQPCB4QPCB4QPCA4EHwgOABwQOCBwQP/KntN/otsO4MrDlKfmfDmo+75B413Pc5CkaGnSMzLyz1EBkFN6llVlzCHXrYbYHzOULnaaVrlFw44BseEDwgeEDwgOABwQOCB8EDggcEDwgeEDwgeEDwgOABwQOCBwQPX+uZaZeYFdcyMywxL20L7ekI/M695B7Ngv2cDffo/G/hhg1dPRwydeBnwZqJa99DB79hwmzqoeyVHhA8IHhA8CB4QPCA4AHBA4IHBA8IHhA8IHhA8IDgQfCA4AHBA4IH3uz8jX717KxnzbtkDxLXnlgzcd33y/fys+YsuEePqyH4xI2aocPUML009RBpGQ45CtZMPpxe/RDxSg++4QHBA4IHBA8IHhA8IHhA8IDgAcEDggfBA4IHBA8IHhA8IHhA8MBin5l2iSGB5+I1E0MX99CaM3DtiTX3kt+52izZz+XXf/4e+IbJrVvo5jccpuceXYF71DB08h6Zgair1zy80gOCBwQPCB4QPCB4QPCA4EHwgOABwQOCBwQPCB4QPCB4QPCA4AHBwxc6R2a2WWJWWmKmXcuAxJTE9d8l9/0ouT/76uATA/3uwKE/QhuaeNg1DJxMxX6VBJ9wvf3Me6UH3/CA4AHBA4IHBA8IHhA8IHhA8IDgAcGD4AHBA4IHBA8IHhA8IHhgsc9Mu9WzsxKDHFODMUfBuqm5bomBk4nZgw1DQRPXfiSCT23m6nWvkoO0jQ53IPh9dEzCTfxDOkIP5bn6BgG+4QHBA4IHBA8IHhA8IHhA8IDgAcEDggfBA4IHBA8IHhA8IHhA8MBCyZl2LcMMG+batczJ20rWTHn9WXqCv0fHQL/EhiauPTFhtmXQ6CwJdAudpfvtZ8krPfiGBwQPCB4QPCB4QPCA4AHBA4IHBA8IHgQPCB4QPCB4QPCA4AHBA4s9M+2e+XNXwW/dQg+olsGYif1cPWh0L7n2xG/cR8Hw0nNkhi6OwEPkCN2kO7DuHTig3zpodAbOUurBtL39LHmlB9/wgOABwQOCBwQPCB4QPCB4QPCA4AHBg+ABwQOCBwQPCB4QPCB4YLEzGP7q+V6JGWR36LqPwLXPgv3cQuc0MRwyseb99v08R8eU0U+cs+DGp96aVl/7VfAbkw+RxPl8/fBSr/TgGx4QPCB4QPCA4AHBA4IHBA8IHhA8IHgQPCB4QPCA4AHBA4IHBA8sdgYfJIlZZIkhgQ0z/VKz4vaC3zpL7lHFfp6hDU0Ev5XENEdmGu744v1MDPD8yuGlXunBNzwgeEDwgOABwQOCBwQPCB4QPCB4QPAgeEDwgOABwQOCBwQPCB5Y7Jlpd4QeJImBk4k5eQ3z/B5XwXlqGYyZWjOxn0v7/CfAAMrKqB7xcqi5AAAAAElFTkSuQmCC") repeat;
  }

  main {
    width: 100vw;
    height: 100vh;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    padding: 0 5vw;

    & {
      * {
        z-index: 1;
      }

      ol {
        z-index: 0;
      }
    }

    #equal-rect {
      display: flex;
      aspect-ratio: 1/1;
      width: 50vmin;
      /* max-width: 50vw; */
      flex-direction: column;
      gap: 1px;

      &:has([style*="display"]) {
        transform: translate(0, 14vmin) rotate(-45deg);
      }

      &>li {
        flex: 1;

        ol {
          width: 100%;
          height: 100%;
          display: flex;
          justify-content: end;
          align-items: center;
          gap: 1px;

          li {
            min-height: 20px;
            height: 100%;
            aspect-ratio: 1/1;
            position: relative;
            white-space: nowrap;

            &[row]::after {
              position: absolute;
              content: attr(row);
              right: 70%;
              bottom: 100%;
              transform-origin: right bottom;
              transform: rotate(45deg) translate(-1.5vmin, -1.5vmin);
              font-size: min(100%, 3vmin);
            }

            &[col]::before {
              position: absolute;
              content: attr(col);
              left: 100%;
              bottom: 30%;
              transform-origin: left bottom;
              transform: rotate(45deg) translate(1.5vmin, -1.5vmin);
              font-size: min(100%, 3vmin);
            }
          }
        }
      }
    }

    ul {
      /* width: 100vw; */
      display: flex;
      align-items: center;
      padding: 0 0.5rem;
      gap: 0.5rem;
      margin: 0.5rem 0;
      flex-wrap: wrap;

      button {
        width: 100%;
        padding: 0 0.5rem;
        border-radius: 0.5px;
      }

      pre {
        padding: 0 0.5rem;
        border-radius: 0.5px;
      }
    }
  }
</style>

<script>
  function evaluate(str) {
    try {
      return Function(`return (${str})`)();
    }
    catch (e) {
      return e;
    }
  };
  function prefixEvaluate(operator, a, b) {
    const infix = operator.replace(/(\&\&|\|\|)/g, t => `(${b})${t}(${a})`);
    const res = evaluate(`(${a})${infix}(${b})`);
    return res instanceof Error ? void 0 : res;
  };
</script>